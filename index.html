<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etho-Track - Bilan Transition Canine</title>
    
    <!-- Meta tags pour PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Manifeste JSON pour l'installation sur smartphone -->
    <link rel="manifest" id="manifest-placeholder">

    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de React et Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        /* Emp√™cher le d√©filement √©lastique sur iOS pour un feeling plus "App" */
        body {
            overscroll-behavior-y: contain;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // G√©n√©ration dynamique du manifeste pour permettre le d√©ploiement sur une seule page
        const manifest = {
            "name": "Etho-Track Canine",
            "short_name": "EthoTrack",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#4f46e5",
            "theme_color": "#4f46e5",
            "icons": [
                {
                    "src": "https://cdn-icons-png.flaticon.com/512/616/616408.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);

        // --- ICONES ---
        const Icons = {
            Activity: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            ),
            ClipboardList: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
            ),
            MapPin: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
            ),
            Save: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            ),
            Play: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            ),
            Square: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>
            ),
            RotateCcw: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            ),
            Camera: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            )
        };

        const App = () => {
            const [dogName, setDogName] = useState("Sanka");
            const [dogPhoto, setDogPhoto] = useState(null);
            const [sessions, setSessions] = useState([]);
            const [location, setLocation] = useState("Localisation...");
            const [formData, setFormData] = useState({
                date: new Date().toLocaleDateString('fr-FR'),
                environnement: 'campagne',
                typeSortie: 'travail',
                latence: '2',
                excitation: 3,
                reactionSociale: 'indifference',
                notes: ''
            });
            const [message, setMessage] = useState(null);
            const [timer, setTimer] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        async (pos) => {
                            try {
                                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                                const data = await res.json();
                                setLocation(data.address.city || data.address.town || "Lieu inconnu");
                            } catch (e) { setLocation("Position OK"); }
                        }
                    );
                }
            }, []);

            useEffect(() => {
                if (isTimerRunning) {
                    timerRef.current = setInterval(() => setTimer(t => t + 0.1), 100);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning]);

            const handleSave = () => {
                setSessions([formData, ...sessions]);
                setMessage("Session enregistr√©e !");
                setTimeout(() => setMessage(null), 3000);
                setFormData({ ...formData, notes: '' });
                setTimer(0);
                setIsTimerRunning(false);
            };

            return (
                <div className="max-w-md mx-auto bg-gray-50 min-h-screen pb-10 shadow-2xl font-sans text-gray-800">
                    {message && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-indigo-600 text-white px-6 py-2 rounded-full shadow-lg font-bold animate-pulse">
                            {message}
                        </div>
                    )}

                    <header className="bg-gradient-to-br from-indigo-700 to-indigo-900 text-white p-6 rounded-b-[2.5rem] shadow-xl relative">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-2">
                                    <Icons.Activity /> Etho-Track
                                </h1>
                                <p className="text-indigo-200 text-xs mt-1">Mode Application Install√©e</p>
                            </div>
                            <div className="bg-white/10 px-3 py-1 rounded-full backdrop-blur-md text-[10px] flex items-center gap-1">
                                <Icons.MapPin /> {location}
                            </div>
                        </div>
                    </header>

                    <main className="p-4 space-y-4 -mt-4">
                        <div className="bg-white p-6 rounded-[2rem] shadow-sm flex flex-col items-center gap-3">
                            <div className="relative w-24 h-24">
                                <div className="w-full h-full rounded-full overflow-hidden bg-indigo-50 border-4 border-white shadow flex items-center justify-center">
                                    {dogPhoto ? <img src={dogPhoto} className="w-full h-full object-cover" /> : <span className="text-3xl">üêï</span>}
                                </div>
                                <button onClick={() => fileInputRef.current.click()} className="absolute bottom-0 right-0 bg-indigo-600 text-white p-1.5 rounded-full shadow-lg">
                                    <Icons.Camera />
                                </button>
                                <input type="file" ref={fileInputRef} onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (ev) => setDogPhoto(ev.target.result);
                                    reader.readAsDataURL(e.target.files[0]);
                                }} accept="image/*" className="hidden" />
                            </div>
                            <input type="text" value={dogName} onChange={(e) => setDogName(e.target.value)} className="text-xl font-black text-indigo-900 text-center border-none bg-transparent focus:ring-0" />
                        </div>

                        <div className="bg-white p-6 rounded-[2rem] shadow-sm space-y-4 border border-gray-100">
                            <h2 className="text-indigo-900 font-bold flex items-center gap-2 border-b pb-2">
                                <Icons.ClipboardList /> Nouvelle Saisie
                            </h2>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <select className="p-3 bg-gray-50 rounded-xl text-sm" onChange={(e) => setFormData({...formData, environnement: e.target.value})}>
                                    <option value="campagne">üèûÔ∏è Campagne</option>
                                    <option value="ville">üèôÔ∏è Ville</option>
                                    <option value="plage">üèñÔ∏è Plage</option>
                                </select>
                                <select className="p-3 bg-gray-50 rounded-xl text-sm" onChange={(e) => setFormData({...formData, typeSortie: e.target.value})}>
                                    <option value="balade">ü¶Æ Balade</option>
                                    <option value="travail">üéØ Travail</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-3 bg-indigo-50 p-3 rounded-2xl border border-indigo-100">
                                <div className="flex-1 text-center">
                                    <span className="text-xl font-mono font-black">{timer.toFixed(1)}s</span>
                                </div>
                                <button onClick={() => setIsTimerRunning(!isTimerRunning)} className={`p-2 rounded-xl text-white ${isTimerRunning ? 'bg-red-500' : 'bg-indigo-600'}`}>
                                    {isTimerRunning ? <Icons.Square /> : <Icons.Play />}
                                </button>
                                <button onClick={() => {setTimer(0); setIsTimerRunning(false)}} className="p-2 bg-white text-indigo-600 rounded-xl border border-indigo-100">
                                    <Icons.RotateCcw />
                                </button>
                            </div>

                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-400 flex justify-between">Excitation <span>{formData.excitation}/5</span></label>
                                <input type="range" min="1" max="5" value={formData.excitation} onChange={(e) => setFormData({...formData, excitation: e.target.value})} className="w-full h-2 bg-indigo-100 rounded-lg appearance-none accent-indigo-600"/>
                            </div>

                            <textarea value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} placeholder="Observations..." className="w-full p-4 bg-gray-50 rounded-2xl text-sm h-20 outline-none resize-none"></textarea>

                            <button onClick={handleSave} className="w-full bg-green-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">
                                SAUVEGARDER LA SESSION
                            </button>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
