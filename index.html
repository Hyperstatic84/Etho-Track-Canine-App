<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etho-Track - Bilan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Fond global indigo profond avec d√©grad√© */
        body {
            background: linear-gradient(135deg, #3730a3 0%, #1e1b4b 100%);
            min-height: 100vh;
        }

        /* Aspect verre d√©poli pour les cartes */
        .glass-card {
            background: rgba(255, 255, 255, 0.12) !important;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        /* STYLE LOGO MODERNE ET FIN */
        .logo-container {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .logo-main {
            font-weight: 200;
            background: linear-gradient(to right, #ffffff, #c7d2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-separator {
            font-weight: 100;
            opacity: 0.3;
            margin: 0 0.1em;
        }

        .logo-accent {
            font-weight: 500;
            color: #818cf8;
            -webkit-text-fill-color: #818cf8;
        }

        /* Ic√¥ne de logo sp√©cifique avec ombre port√©e */
        .logo-icon {
            filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.4));
        }

        /* Menu Burger plus opaque */
        .burger-menu-content {
            background: rgba(30, 27, 75, 0.95) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        /* Syst√®me d'alerte plac√© √† 10% DU HAUT */
        .alert-overlay {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
            width: 80%;
            max-width: 300px;
        }

        .alert-box {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px) saturate(160%);
            -webkit-backdrop-filter: blur(20px) saturate(160%);
            color: #ffffff;
            padding: 1rem 1.25rem;
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            animation: alertIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            font-size: 0.8rem;
        }

        @keyframes alertIn {
            from { opacity: 0; transform: translateY(-40px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .glass-text {
            color: white !important;
        }
        .glass-label {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            background: #ffffff;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid #4f46e5;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .menu-appear {
            animation: slideDown 0.3s ease-out forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            ActivityLogo: (props) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            ),
            ClipboardList: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1-2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
            ),
            MapPin: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
            ),
            Target: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            ),
            Save: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            ),
            FileText: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
            ),
            Play: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            ),
            Square: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>
            ),
            RotateCcw: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            ),
            Camera: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            ),
            Image: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
            ),
            X: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            ),
            Copy: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            ),
            Share: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
            ),
            Volume2: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
            ),
            Bell: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
            ),
            Users: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            ),
            Wind: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>
            ),
            Plus: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            ),
            Minus: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
            ),
            AlertTriangle: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            ),
            Check: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            ),
            Link: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            ),
            Menu: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            ),
            Trash: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            ),
            RefreshCw: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 1 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
            ),
            Download: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            ),
            Upload: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            )
        };

        const App = () => {
            const [dogName, setDogName] = useState("Sanka");
            const [dogAge, setDogAge] = useState("");
            const [dogBreed, setDogBreed] = useState("");
            const [ownerName, setOwnerName] = useState("");
            const [dogPhoto, setDogPhoto] = useState(null);
            const [sessions, setSessions] = useState([]);
            
            const [savedProfiles, setSavedProfiles] = useState([]);
            const [showProfilesMenu, setShowProfilesMenu] = useState(false);
            const [location, setLocation] = useState("");
            const [coords, setCoords] = useState({ lat: null, lng: null });
            const [isGpsActive, setIsGpsActive] = useState(false);
            const [weather, setWeather] = useState(null);
            const [showPhotoMenu, setShowPhotoMenu] = useState(false);
            const [formData, setFormData] = useState({
                date: new Date().toLocaleDateString('fr-FR'),
                environnement: 'campagne',
                typeSortie: 'balade',
                attache: 'laisse',
                excitation: 3,
                aboiement: false,
                reactionSociale: 'indifference',
                tempsRappel: '0-5s',
                notes: '',
                timer: 0
            });
            const [showReport, setShowReport] = useState(false);
            const [message, setMessage] = useState(null);
            const [timer, setTimer] = useState(0);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [rappelCount, setRappelCount] = useState(0);
            const [confirmReset, setConfirmReset] = useState(false);
            
            const timerRef = useRef(null);
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);
            const menuRef = useRef(null);
            const jsonImportRef = useRef(null);

            // Charger les profils au d√©marrage
            useEffect(() => {
                const stored = localStorage.getItem('etho_track_profiles');
                if (stored) {
                    setSavedProfiles(JSON.parse(stored));
                }
            }, []);

            // Sauvegarde automatique du profil actuel dans les profils enregistr√©s
            const handleSaveProfile = () => {
                const currentProfile = {
                    id: dogName.toLowerCase().replace(/\s/g, '-') || Date.now().toString(),
                    name: dogName,
                    age: dogAge,
                    breed: dogBreed,
                    owner: ownerName,
                    photo: dogPhoto,
                    sessions: sessions,
                    lastUpdated: new Date().toISOString()
                };

                const newProfiles = [...savedProfiles.filter(p => p.id !== currentProfile.id), currentProfile];
                setSavedProfiles(newProfiles);
                localStorage.setItem('etho_track_profiles', JSON.stringify(newProfiles));
                setMessage("PROFIL SAUVEGARD√â !");
                setTimeout(() => setMessage(null), 3000);
            };

            // --- NOUVELLES FONCTIONS DE FICHIER JSON ---

            const handleExportJSON = () => {
                const allData = {
                    profiles: savedProfiles,
                    currentDog: {
                        name: dogName,
                        age: dogAge,
                        breed: dogBreed,
                        owner: ownerName,
                        photo: dogPhoto,
                        sessions: sessions
                    },
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(allData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const fileName = `etho_track_backup_${dogName}_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', fileName);
                linkElement.click();
                
                setMessage("JSON EXPORT√â");
                setTimeout(() => setMessage(null), 3000);
                setShowProfilesMenu(false);
            };

            const handleImportJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        
                        // Validation sommaire
                        if (json.profiles && Array.isArray(json.profiles)) {
                            setSavedProfiles(json.profiles);
                            localStorage.setItem('etho_track_profiles', JSON.stringify(json.profiles));
                            
                            // Si des donn√©es actuelles sont pr√©sentes, on les charge aussi
                            if (json.currentDog) {
                                const d = json.currentDog;
                                setDogName(d.name);
                                setDogAge(d.age || "");
                                setDogBreed(d.breed || "");
                                setOwnerName(d.owner || "");
                                setDogPhoto(d.photo || null);
                                setSessions(d.sessions || []);
                            }
                            
                            setMessage("DONN√âES RESTAUR√âES");
                        } else {
                            setMessage("JSON INVALIDE");
                        }
                    } catch (err) {
                        setMessage("ERREUR LECTURE");
                    }
                    setTimeout(() => setMessage(null), 3000);
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
                setShowProfilesMenu(false);
            };

            // --- FIN DES FONCTIONS JSON ---

            const handleLoadProfile = (profile) => {
                setDogName(profile.name);
                setDogAge(profile.age || "");
                setDogBreed(profile.breed || "");
                setOwnerName(profile.owner || "");
                setDogPhoto(profile.photo || null);
                setSessions(profile.sessions || []);
                setShowProfilesMenu(false);
                setMessage(`${profile.name} charg√©`);
                setTimeout(() => setMessage(null), 2000);
            };

            const handleDeleteProfile = (e, id) => {
                e.stopPropagation();
                const newProfiles = savedProfiles.filter(p => p.id !== id);
                setSavedProfiles(newProfiles);
                localStorage.setItem('etho_track_profiles', JSON.stringify(newProfiles));
            };

            const handleResetTotal = () => {
                if (!confirmReset) {
                    setConfirmReset(true);
                    setMessage("CONFIRMATION REQUISE");
                    setTimeout(() => {
                        setConfirmReset(false);
                        if (message === "CONFIRMATION REQUISE") setMessage(null);
                    }, 4000);
                    return;
                }
                setSessions([]);
                setTimer(0);
                setRappelCount(0);
                setIsTimerRunning(false);
                setConfirmReset(false);
                setMessage("HISTORIQUE EFFAC√â");
                setTimeout(() => setMessage(null), 3000);
            };

            const fetchWeather = async (lat, lon) => {
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`);
                    const data = await response.json();
                    if (data.current) {
                        setWeather({
                            temp: Math.round(data.current.temperature_2m),
                            wind: Math.round(data.current.wind_speed_10m),
                            code: data.current.weather_code
                        });
                    }
                } catch (e) {
                    console.error("M√©t√©o indisponible", e);
                }
            };

            const requestGpsAccess = () => {
                if ("geolocation" in navigator) {
                    setMessage("RECHERCHE GPS...");
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            setCoords({ lat: latitude.toFixed(4), lng: longitude.toFixed(4) });
                            fetchWeather(latitude, longitude);
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                                const data = await response.json();
                                const city = data.address.city || data.address.town || data.address.village || "Zone isol√©e";
                                setLocation(city);
                                setIsGpsActive(true);
                                setMessage("POSITION TROUV√âE");
                            } catch (error) {
                                setLocation(`${latitude.toFixed(2)}, ${longitude.toFixed(2)}`);
                                setIsGpsActive(true);
                                setMessage("COORDONN√âES FIX√âES");
                            }
                            setTimeout(() => setMessage(null), 2000);
                        },
                        (error) => {
                            setMessage(error.code === 1 ? "ACC√àS GPS REFUS√â" : "ERREUR GPS");
                            setIsGpsActive(false);
                            setTimeout(() => setMessage(null), 3000);
                        }
                    );
                } else {
                    setMessage("GPS NON SUPPORT√â");
                    setTimeout(() => setMessage(null), 3000);
                }
            };

            useEffect(() => {
                if (isTimerRunning) {
                    timerRef.current = setInterval(() => setTimer(t => t + 0.1), 100);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isTimerRunning]);

            const handlePhotoUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onloadend = () => {
            const img = new Image();
            img.onload = () => {
                // Cr√©ation d'un canvas pour le redimensionnement
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 150;
                const MAX_HEIGHT = 150;
                let width = img.width;
                let height = img.height;

                // Calcul des proportions pour garder un ratio correct
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Exportation en format JPEG avec une qualit√© de 0.7 (70%)
                // Cela r√©duit consid√©rablement le poids du texte Base64
                const optimizedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                
                setDogPhoto(optimizedDataUrl);
                setShowPhotoMenu(false);
                setMessage("PHOTO OPTIMIS√âE");
                setTimeout(() => setMessage(null), 2000);
            };
            img.src = reader.result;
        };
        reader.readAsDataURL(file);
    }
};

            const handleSaveSession = () => {
                const sessionToSave = { 
                    ...formData, 
                    timer: timer.toFixed(1), 
                    location,
                    coords: coords.lat ? `${coords.lat}, ${coords.lng}` : null,
                    rappels: rappelCount,
                    weather: weather ? `${weather.temp}¬∞C, vent ${weather.wind}km/h` : null
                };
                setSessions([sessionToSave, ...sessions]);
                setMessage("SESSION VALID√âE !");
                setTimeout(() => setMessage(null), 3000);
                setFormData({ ...formData, notes: '', aboiement: false, date: new Date().toLocaleDateString('fr-FR') });
                setIsTimerRunning(false);
                setTimer(0);
                setRappelCount(0);
            };

            const calculateStats = () => {
                if (sessions.length === 0) return null;
                const avgExcitation = (sessions.reduce((acc, s) => acc + parseInt(s.excitation), 0) / sessions.length).toFixed(1);
                const focusRate = (sessions.filter(s => s.reactionSociale === 'indifference' || s.reactionSociale === 'distant').length / sessions.length * 100).toFixed(0);
                const barkRate = (sessions.filter(s => s.aboiement).length / sessions.length * 100).toFixed(0);
                return { avgExcitation, focusRate, barkRate };
            };

            const generateReportText = () => {
                const targetCount = 14;
                const sessionsToAnalyze = sessions.slice(0, targetCount);
                if (sessionsToAnalyze.length === 0) return "Aucune session enregistr√©e pour le moment.";

                const avgExc = (sessionsToAnalyze.reduce((acc, s) => acc + parseInt(s.excitation), 0) / sessionsToAnalyze.length).toFixed(1);
                const barkSessionsCount = sessionsToAnalyze.filter(s => s.aboiement).length;
                const conflictSessionsCount = sessionsToAnalyze.filter(s => s.reactionSociale === 'conflit').length;
                const environments = [...new Set(sessionsToAnalyze.map(s => s.environnement))].join(', ');
                
                let text = `üêæ RAPPORT DE SUIVI : ${dogName.toUpperCase()}\n`;
                if(dogBreed || dogAge || ownerName) {
                    text += `${dogBreed ? `Race: ${dogBreed} | ` : ''}${dogAge ? `√Çge: ${dogAge} | ` : ''}${ownerName ? `Propri√©taire: ${ownerName}` : ''}\n`;
                }
                text += `-------------------------------------------\n`;
                text += `P√©riode : Analyse des ${sessionsToAnalyze.length} derni√®res sessions\n`;
                text += `Lieux fr√©quent√©s : ${environments}\n`;
                text += `Niveau d'excitation moyen : ${avgExc}/5\n`;
                text += `Sessions avec aboiements : ${barkSessionsCount}/${sessionsToAnalyze.length}\n`;
                if (conflictSessionsCount > 0) {
                    text += `√âpisodes de conflit : ${conflictSessionsCount}/${sessionsToAnalyze.length}\n`;
                }
                text += `\nOBSERVATIONS D√âTAILL√âES :\n`;

                sessionsToAnalyze.forEach((s, i) => {
                    const iconSocial = (s.reactionSociale === 'indifference' || s.reactionSociale === 'distant') ? '‚úÖ' : (s.reactionSociale === 'conflit' ? 'üõë' : '‚ö†Ô∏è');
                    const iconBark = s.aboiement ? ' üîä [ABOIEMENT]' : '';
                    const attacheStr = s.attache ? ` | Attache : ${s.attache}` : '';
                    const rappelsStr = s.rappels > 0 ? ` | Rappels : ${s.rappels}` : '';
                    const weatherStr = s.weather ? ` (${s.weather})` : '';
                    const coordsStr = s.coords ? ` [G√©o: ${s.coords}]` : '';
                    text += `- ${s.date}${weatherStr}${coordsStr} [${s.location || 'Inconnu'}] : ${iconSocial} R√©action : ${s.reactionSociale}${attacheStr}${iconBark}. | Rappel : ${s.tempsRappel}.${rappelsStr} ${s.notes ? 'Note : ' + s.notes : ''}\n`;
                });

                text += `\nSYNTH√àSE √âTHOLOGIQUE :\n`;
                const rapidRecalls = sessionsToAnalyze.filter(s => s.tempsRappel === '0-5s').length;
                const recallRate = (rapidRecalls / sessionsToAnalyze.length * 100).toFixed(0);

                if (avgExc > 3.5 || conflictSessionsCount > 2) {
                    text += `Sur cet √©chantillon, on observe une r√©activit√© ou des conflits encore fr√©quents. Il est vivement conseill√© de r√©duire la difficult√© des environnements. `;
                } else if (avgExc < 2.5) {
                    text += `${dogName} montre une belle stabilit√© √©motionnelle sur les derni√®res entr√©es. `;
                }

                if (barkSessionsCount > (sessionsToAnalyze.length / 2)) {
                    text += `Une forte pr√©sence d'aboiements est not√©e (${Math.round(barkSessionsCount/sessionsToAnalyze.length*100)}% des cas). `;
                }

                text += `Le rappel est jug√© imm√©diat (0-5s) dans ${recallRate}% des cas observ√©s.`;

                return text;
            };

            const handleShareReport = async () => {
                const text = generateReportText();
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: `Bilan Etho-Track - ${dogName}`,
                            text: text
                        });
                    } catch (err) {
                        console.log("Erreur partage:", err);
                    }
                } else {
                    const mailtoUrl = `mailto:?subject=Bilan Etho-Track - ${dogName}&body=${encodeURIComponent(text)}`;
                    window.location.href = mailtoUrl;
                }
            };

            const stats = calculateStats();

            const getWeatherEmoji = (code) => {
                if (code === 0) return "‚òÄÔ∏è";
                if (code <= 3) return "üå§Ô∏è";
                if (code <= 48) return "üå´Ô∏è";
                if (code <= 67) return "üåßÔ∏è";
                if (code <= 77) return "‚ùÑÔ∏è";
                if (code <= 82) return "üå¶Ô∏è";
                if (code <= 99) return "‚õàÔ∏è";
                return "‚òÅÔ∏è";
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-10 font-sans text-white relative overflow-x-hidden">
                    <div className="fixed top-[10%] left-[-20%] w-64 h-64 bg-indigo-500/30 rounded-full blur-[100px] -z-10"></div>
                    <div className="fixed bottom-[20%] right-[-10%] w-80 h-80 bg-purple-500/20 rounded-full blur-[120px] -z-10"></div>

                    {message && (
                        <div className="alert-overlay">
                            <div className="alert-box">
                                <span className="text-white"><Icons.Check /></span>
                                <span>{message}</span>
                            </div>
                        </div>
                    )}

                    {showReport && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-md p-4 flex items-center justify-center">
                            <div className="glass-card w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl space-y-4 animate-in fade-in zoom-in duration-300">
                                <div className="flex justify-between items-center border-b border-white/10 pb-3">
                                    <h3 className="font-black glass-text flex items-center gap-2 uppercase tracking-tighter text-xs">
                                        <Icons.FileText /> Rapport Client
                                    </h3>
                                    <button onClick={() => setShowReport(false)} className="text-white/40 p-1 hover:text-white transition-colors">
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="bg-black/20 p-4 rounded-2xl max-h-[40vh] overflow-y-auto border border-white/5">
                                    <pre className="text-[11px] whitespace-pre-wrap font-mono leading-relaxed text-white/80">
                                        {generateReportText()}
                                    </pre>
                                </div>
                                <div className="grid grid-cols-1 gap-2">
                                    <button 
                                        onClick={() => {
                                            const text = generateReportText();
                                            const textArea = document.createElement("textarea");
                                            textArea.value = text;
                                            document.body.appendChild(textArea);
                                            textArea.select();
                                            document.execCommand('copy');
                                            document.body.removeChild(textArea);
                                            setMessage("COPI√â DANS LE PRESSE-PAPIER");
                                            setTimeout(() => setMessage(null), 2000);
                                        }}
                                        className="w-full bg-white/10 text-white font-bold py-3 rounded-2xl border border-white/20 flex items-center justify-center gap-2 active:scale-95 transition-transform"
                                    >
                                        <Icons.Copy /> COPIER
                                    </button>
                                    <button 
                                        onClick={handleShareReport}
                                        className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
                                    >
                                        <Icons.Share /> ENVOYER LE BILAN
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className="p-6 pt-20 flex flex-col items-center">
                        <div className="relative z-10 text-center mb-6">
                            <h1 className="logo-container text-4xl flex items-center justify-center italic">
                                <Icons.ActivityLogo className="logo-icon text-green-400 mr-3" />
                                <span className="logo-main">Etho</span>
                                <span className="logo-separator"> ‚Äì </span>
                                <span className="logo-accent">Track</span>
                            </h1>
                        </div>
                        
                        <div className="w-full px-2 flex flex-col items-center gap-3">
                            {!isGpsActive ? (
                                <button 
                                    onClick={requestGpsAccess}
                                    className="w-full max-w-[280px] bg-green-500/80 hover:bg-green-400 text-white px-6 py-4 rounded-full backdrop-blur-md border border-white/20 flex items-center justify-center gap-2 text-xs font-black uppercase animate-pulse shadow-lg tracking-widest"
                                >
                                    <Icons.MapPin /> Activer le GPS
                                </button>
                            ) : (
                                <div className="w-full bg-white/10 p-5 rounded-[2.5rem] backdrop-blur-md border border-white/10 flex flex-col items-center gap-3 animate-fade-in shadow-xl">
                                    <div className="flex flex-col items-center gap-1 w-full border-b border-white/5 pb-4">
                                        <div className="flex items-center gap-2 text-green-400">
                                            <Icons.MapPin />
                                            <span className="text-sm font-black uppercase tracking-widest truncate max-w-[220px]">{location}</span>
                                        </div>
                                        {coords.lat && (
                                            <div className="flex items-center gap-1 opacity-50 text-[8px] font-mono mt-0.5 tracking-tighter">
                                                <Icons.Target />
                                                <span>LAT: {coords.lat} | LNG: {coords.lng}</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {weather ? (
                                        <div className="flex items-center justify-around w-full">
                                            <div className="flex flex-col items-center">
                                                <span className="text-2xl mb-1">{getWeatherEmoji(weather.code)}</span>
                                                <span className="text-[10px] font-bold uppercase opacity-60">Ciel</span>
                                            </div>
                                            <div className="w-px h-10 bg-white/10"></div>
                                            <div className="flex flex-col items-center">
                                                <span className="text-xl font-black">{weather.temp}¬∞C</span>
                                                <span className="text-[10px] font-bold uppercase opacity-60">Temp.</span>
                                            </div>
                                            <div className="w-px h-10 bg-white/10"></div>
                                            <div className="flex flex-col items-center">
                                                <div className="flex items-center gap-1">
                                                    <Icons.Wind />
                                                    <span className="text-sm font-black">{weather.wind}</span>
                                                </div>
                                                <span className="text-[10px] font-bold uppercase opacity-60">km/h</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-4 py-2 animate-pulse opacity-50">
                                            <div className="w-8 h-8 bg-white/20 rounded-full"></div>
                                            <div className="w-24 h-4 bg-white/20 rounded-full"></div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {stats && (
                            <div className="relative z-10 flex gap-4 mt-8 w-full px-2">
                                <div className="bg-white/5 flex-1 p-4 rounded-[1.5rem] backdrop-blur-sm border border-white/10 text-center shadow-sm">
                                    <p className="text-[10px] uppercase opacity-50 font-black tracking-widest mb-1">Focus Ma√Ætre</p>
                                    <p className="text-2xl font-black tracking-tighter">{stats.focusRate}%</p>
                                </div>
                                <div className="bg-white/5 flex-1 p-4 rounded-[1.5rem] backdrop-blur-sm border border-white/10 text-center shadow-sm">
                                    <p className="text-[10px] uppercase opacity-50 font-black tracking-widest mb-1">Excitation</p>
                                    <p className="text-2xl font-black tracking-tighter">{stats.avgExcitation}</p>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="p-4 space-y-6 relative z-20">
                        <div className="glass-card p-6 rounded-[2.5rem] flex flex-col items-center gap-4 relative overflow-visible z-40">
                            <div className="absolute top-6 left-6 z-30" ref={menuRef}>
                                <button 
                                    onClick={() => setShowProfilesMenu(!showProfilesMenu)}
                                    className="p-2 text-white/50 hover:text-white transition-colors"
                                >
                                    <Icons.Menu />
                                </button>
                                {showProfilesMenu && (
                                    <div className="absolute top-10 left-0 w-72 burger-menu-content rounded-3xl shadow-2xl py-3 menu-appear z-50">
                                        <div className="px-4 pb-2 border-b border-white/10 mb-2 flex justify-between items-center">
                                            <span className="text-[10px] font-black text-white/40 uppercase tracking-widest">Options & Profils</span>
                                            <button onClick={() => setShowProfilesMenu(false)}><Icons.X className="w-4 h-4 text-white/20" /></button>
                                        </div>

                                        {/* SECTION JSON - NOUVEAU */}
                                        <div className="px-4 py-3 grid grid-cols-2 gap-2 border-b border-white/10 mb-2">
                                            <button 
                                                onClick={handleExportJSON}
                                                className="bg-indigo-500/20 hover:bg-indigo-500/40 border border-indigo-400/30 py-3 rounded-xl flex flex-col items-center gap-1 transition-all"
                                            >
                                                <Icons.Download />
                                                <span className="text-[8px] font-black uppercase tracking-tighter text-indigo-200">Exporter JSON</span>
                                            </button>
                                            <button 
                                                onClick={() => jsonImportRef.current.click()}
                                                className="bg-green-500/20 hover:bg-green-500/40 border border-green-400/30 py-3 rounded-xl flex flex-col items-center gap-1 transition-all"
                                            >
                                                <Icons.Upload />
                                                <span className="text-[8px] font-black uppercase tracking-tighter text-green-200">Importer JSON</span>
                                            </button>
                                            <input 
                                                type="file" 
                                                ref={jsonImportRef} 
                                                onChange={handleImportJSON} 
                                                className="hidden" 
                                                accept=".json" 
                                            />
                                        </div>

                                        {savedProfiles.length === 0 ? (
                                            <div className="px-4 py-4 text-xs italic text-white/30">Aucun profil sauvegard√©</div>
                                        ) : (
                                            <div className="max-h-60 overflow-y-auto custom-scroll">
                                                {savedProfiles.map(p => (
                                                    <div 
                                                        key={p.id} 
                                                        onClick={() => handleLoadProfile(p)}
                                                        className="group px-4 py-3 hover:bg-white/10 cursor-pointer flex justify-between items-center transition-all"
                                                    >
                                                        <div className="flex flex-col">
                                                            <span className="font-bold text-sm text-white">{p.name}</span>
                                                            <span className="text-[10px] text-white/40">{p.breed || 'Sans race'} ‚Ä¢ {p.sessions.length} sessions</span>
                                                        </div>
                                                        <button 
                                                            onClick={(e) => handleDeleteProfile(e, p.id)}
                                                            className="p-2 text-white/20 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"
                                                        >
                                                            <Icons.Trash />
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            <button 
                                onClick={handleSaveProfile}
                                className="absolute top-6 right-6 p-2 text-white/50 hover:text-green-400 transition-colors z-30 active:scale-90"
                            >
                                <Icons.Save />
                            </button>

                            <div className="relative w-32 h-32 mt-4">
                                <button 
                                    onClick={() => setShowPhotoMenu(!showPhotoMenu)} 
                                    className="w-full h-full rounded-full overflow-hidden bg-white/10 border-4 border-white/20 shadow-md flex items-center justify-center transition-all hover:scale-105 active:scale-95 group focus:outline-none"
                                >
                                    {dogPhoto ? (
                                        <img src={dogPhoto} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="flex flex-col items-center gap-1">
                                            <span className="text-4xl">üêï</span>
                                            <span className="text-[8px] font-black glass-label uppercase tracking-tighter">Ajouter photo</span>
                                        </div>
                                    )}
                                </button>

                                {showPhotoMenu && (
                                    <div className="absolute top-[80%] left-1/2 -translate-x-1/2 mt-2 w-48 bg-indigo-900 border border-white/10 rounded-2xl shadow-xl py-2 z-40">
                                        <button onClick={() => { cameraInputRef.current.click(); setShowPhotoMenu(false); }} className="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-white hover:bg-white/10">
                                            <Icons.Camera /> Appareil photo
                                        </button>
                                        <button onClick={() => { galleryInputRef.current.click(); setShowPhotoMenu(false); }} className="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-white hover:bg-white/10 border-t border-white/5">
                                            <Icons.Image /> Galerie
                                        </button>
                                    </div>
                                )}
                                <input type="file" ref={cameraInputRef} onChange={handlePhotoUpload} accept="image/*" capture="user" className="hidden" />
                                <input type="file" ref={galleryInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                            </div>
                            
                            <div className="w-full space-y-3">
                                <input type="text" value={dogName} onChange={(e) => setDogName(e.target.value)} className="text-2xl font-black glass-text border-none bg-transparent text-center focus:ring-0 w-full" />
                                
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="flex flex-col items-center">
                                        <label className="text-[9px] font-bold glass-label uppercase tracking-wider mb-1">√Çge</label>
                                        <input 
                                            type="text" 
                                            value={dogAge} 
                                            onChange={(e) => setDogAge(e.target.value)} 
                                            placeholder="-"
                                            className="text-sm font-bold glass-text border-none bg-white/5 rounded-xl text-center focus:ring-0 w-full py-2 placeholder-white/20" 
                                        />
                                    </div>
                                    <div className="flex flex-col items-center">
                                        <label className="text-[9px] font-bold glass-label uppercase tracking-wider mb-1">Race</label>
                                        <input 
                                            type="text" 
                                            value={dogBreed} 
                                            onChange={(e) => setDogBreed(e.target.value)} 
                                            placeholder="-"
                                            className="text-sm font-bold glass-text border-none bg-white/5 rounded-xl text-center focus:ring-0 w-full py-2 placeholder-white/20" 
                                        />
                                    </div>
                                    <div className="flex flex-col items-center">
                                        <label className="text-[9px] font-bold glass-label uppercase tracking-wider mb-1">Proprio</label>
                                        <input 
                                            type="text" 
                                            value={ownerName} 
                                            onChange={(e) => setOwnerName(e.target.value)} 
                                            placeholder="-"
                                            className="text-sm font-bold glass-text border-none bg-white/5 rounded-xl text-center focus:ring-0 w-full py-2 placeholder-white/20" 
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="glass-card p-6 rounded-[2.5rem] space-y-6">
                            <h2 className="glass-text font-black flex items-center gap-2 border-b border-white/10 pb-4 uppercase text-sm tracking-widest">
                                <Icons.ClipboardList /> Saisie Terrain
                            </h2>
                            
                            <div className="grid grid-cols-1 gap-5">
                                <div className="space-y-2">
                                    <label className="text-xs font-black glass-label uppercase px-1">Choix du Milieu</label>
                                    <select 
                                        value={formData.environnement} 
                                        onChange={(e) => setFormData({...formData, environnement: e.target.value})} 
                                        className="w-full p-5 bg-white/5 border-2 border-white/10 rounded-3xl text-lg outline-none font-bold glass-text focus:border-white/20 transition-all appearance-none"
                                        style={{backgroundImage: 'url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'white\' stroke-width=\'3\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3e%3cpolyline points=\'6 9 12 15 18 9\'%3e%3c/polyline%3e%3c/svg%3e")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 1.25rem center', backgroundSize: '1.5em'}}
                                    >
                                        <option value="campagne" className="bg-indigo-900">üèûÔ∏è Campagne</option>
                                        <option value="ville" className="bg-indigo-900">üèôÔ∏è Ville</option>
                                        <option value="foret" className="bg-indigo-900">üå≤ For√™t</option>
                                        <option value="plage" className="bg-indigo-900">üèñÔ∏è Plage</option>
                                        <option value="montagne" className="bg-indigo-900">‚õ∞Ô∏è Montagne</option>
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-black glass-label uppercase px-1">Activit√© en cours</label>
                                    <select 
                                        value={formData.typeSortie} 
                                        onChange={(e) => setFormData({...formData, typeSortie: e.target.value})} 
                                        className="w-full p-5 bg-white/5 border-2 border-white/10 rounded-3xl text-lg outline-none font-bold glass-text focus:border-white/20 transition-all appearance-none"
                                        style={{backgroundImage: 'url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'white\' stroke-width=\'3\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3e%3cpolyline points=\'6 9 12 15 18 9\'%3e%3c/polyline%3e%3c/svg%3e")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 1.25rem center', backgroundSize: '1.5em'}}
                                    >
                                        <option value="travail" className="bg-indigo-900">üéØ Recherche</option>
                                        <option value="mulotage" className="bg-indigo-900">üê≠ Mulotage</option>
                                        <option value="balade" className="bg-indigo-900">ü¶Æ Balade</option>
                                        <option value="social" className="bg-indigo-900">ü§ù Social</option>
                                        <option value="course" className="bg-indigo-900">üèÉ Course</option>
                                    </select>
                                </div>
                            </div>

                            <div className="space-y-3 p-5 bg-white/5 rounded-3xl border border-white/10">
                                <label className="text-xs font-black glass-text uppercase flex items-center gap-2 mb-2 px-1">
                                    <Icons.Link /> Type d'attache
                                </label>
                                <div className="grid grid-cols-3 gap-3">
                                    {['libre', 'laisse', 'longe'].map((type) => (
                                        <button
                                            key={type}
                                            onClick={() => setFormData({...formData, attache: type})}
                                            className={`py-4 rounded-2xl font-black text-xs uppercase transition-all border active:scale-95 ${
                                                formData.attache === type 
                                                ? 'bg-white text-indigo-900 border-white shadow-lg' 
                                                : 'bg-white/5 border-white/10 text-white/40'
                                            }`}
                                        >
                                            {type}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-2 p-5 bg-white/5 rounded-3xl border border-white/10">
                                <label className="text-xs font-black glass-text uppercase flex items-center gap-2 mb-2 px-1">
                                    <Icons.Users /> R√©action Sociale
                                </label>
                                <select 
                                    value={formData.reactionSociale} 
                                    onChange={(e) => setFormData({...formData, reactionSociale: e.target.value})} 
                                    className="w-full p-5 bg-white/10 border-2 border-white/10 rounded-2xl font-black text-lg glass-text outline-none focus:ring-4 focus:ring-white/5 transition-all appearance-none shadow-sm"
                                    style={{backgroundImage: 'url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'white\' stroke-width=\'3\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3e%3cpolyline points=\'6 9 12 15 18 9\'%3e%3c/polyline%3e%3c/svg%3e")', backgroundRepeat: 'no-repeat', backgroundPosition: 'right 1.25rem center', backgroundSize: '1.5em'}}
                                >
                                    <option value="indifference" className="bg-indigo-900">üòê Focus Ma√Ætre</option>
                                    <option value="distant" className="bg-indigo-900">üçÉ Distant</option>
                                    <option value="vigilance" className="bg-indigo-900">üßê Vigilance</option>
                                    <option value="tension" className="bg-indigo-900">üêï Tension laisse</option>
                                    <option value="contact" className="bg-indigo-900">üöÄ Contact direct</option>
                                    <option value="conflit" className="bg-indigo-900 text-orange-400">üõë Conflit</option>
                                </select>
                            </div>

                            <div className="flex flex-col gap-4 bg-black/20 p-6 rounded-[2.5rem] border border-white/5 shadow-inner">
                                <div className="flex items-center justify-between gap-6">
                                    <div className="flex-1 space-y-1">
                                        <span className="text-[11px] font-bold glass-label block uppercase tracking-wider">Chronom√®tre</span>
                                        <div className="text-4xl font-mono font-black glass-text leading-none">
                                            {timer.toFixed(1)}<span className="text-xl">s</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button 
                                            onClick={() => setIsTimerRunning(!isTimerRunning)} 
                                            className={`w-20 h-20 rounded-2xl shadow-lg flex items-center justify-center transition-all active:scale-90 ${isTimerRunning ? 'bg-red-500 text-white' : 'bg-green-400 text-indigo-900'}`}
                                        >
                                            {isTimerRunning ? <Icons.Square /> : <Icons.Play />}
                                        </button>
                                        <button 
                                            onClick={() => {setIsTimerRunning(false); setTimer(0)}} 
                                            className="w-16 h-16 bg-white/10 text-white rounded-2xl border border-white/20 shadow-sm flex items-center justify-center active:scale-90"
                                        >
                                            <Icons.RotateCcw />
                                        </button>
                                    </div>
                                </div>

                                <div className="h-px bg-white/10 w-full"></div>

                                <div className="flex items-center justify-between">
                                    <div className="space-y-1">
                                        <span className="text-[11px] font-bold glass-label block uppercase tracking-wider">Nombre de rappels</span>
                                        <div className="text-4xl font-black glass-text leading-none">
                                            {rappelCount}
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <button 
                                            onClick={() => setRappelCount(prev => Math.max(0, prev - 1))}
                                            className="w-16 h-16 bg-white/10 text-white rounded-2xl border border-white/20 flex items-center justify-center active:scale-90"
                                        >
                                            <Icons.Minus />
                                        </button>
                                        <button 
                                            onClick={() => setRappelCount(prev => prev + 1)}
                                            className="w-20 h-20 bg-green-400 text-indigo-900 rounded-2xl shadow-xl flex items-center justify-center active:scale-95"
                                        >
                                            <Icons.Plus />
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-3 p-4 bg-white/5 rounded-2xl border border-white/10">
                                <label className="text-[10px] font-bold glass-label uppercase flex items-center gap-1">
                                    <Icons.Bell /> D√©lai de r√©ponse au rappel
                                </label>
                                <div className="grid grid-cols-3 gap-3">
                                    {[
                                        { label: '0-5s', color: 'bg-green-500' },
                                        { label: '5-10s', color: 'bg-orange-500' },
                                        { label: '10-20s', color: 'bg-red-500' }
                                    ].map((val) => {
                                        const isActive = formData.tempsRappel === val.label;
                                        return (
                                            <button
                                                key={val.label}
                                                onClick={() => setFormData({...formData, tempsRappel: val.label})}
                                                className={`py-4 text-sm font-black rounded-2xl border transition-all active:scale-95 ${
                                                    isActive 
                                                    ? `${val.color} text-white border-white shadow-lg` 
                                                    : 'bg-white/5 text-white/40 border-white/10'
                                                }`}
                                            >
                                                {val.label}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="space-y-6 py-4">
                                <div className="space-y-4">
                                    <label className="text-xs font-black glass-text uppercase flex justify-between px-1">
                                        Niveau d'excitation <span className="text-white text-lg">{formData.excitation}/5</span>
                                    </label>
                                    <div className="relative px-2">
                                        <input 
                                            type="range" 
                                            min="1" 
                                            max="5" 
                                            step="1"
                                            value={formData.excitation} 
                                            onChange={(e) => setFormData({...formData, excitation: e.target.value})} 
                                            className="w-full h-5 bg-white/10 rounded-full appearance-none cursor-pointer"
                                        />
                                        <div className="flex justify-between mt-2 px-1 text-[10px] font-bold glass-label">
                                            <span>CALME</span>
                                            <span>PIC</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-2">
                                    <button 
                                        onClick={() => setFormData({...formData, aboiement: !formData.aboiement})}
                                        className={`w-full py-5 rounded-3xl flex items-center justify-center gap-3 font-black text-lg transition-all duration-300 border-2 active:scale-[0.98] ${formData.aboiement ? 'bg-orange-500 border-orange-400 text-white shadow-lg' : 'bg-white/5 border-white/10 text-white/40'}`}
                                    >
                                        <div className={`${formData.aboiement ? 'animate-bounce' : ''}`}>
                                            <Icons.Volume2 />
                                        </div>
                                        {formData.aboiement ? 'ABOIEMENT : OUI' : 'ABOIEMENT : NON'}
                                        {formData.aboiement && <Icons.AlertTriangle />}
                                    </button>
                                </div>
                            </div>

                            <textarea 
                                value={formData.notes} 
                                onChange={(e) => setFormData({...formData, notes: e.target.value})} 
                                placeholder="Notes de session..." 
                                className="w-full p-5 bg-white/5 rounded-[2rem] text-sm h-32 outline-none resize-none border border-white/10 focus:border-white/30 focus:bg-white/10 glass-text transition-all font-medium placeholder-white/20"
                            ></textarea>

                            <button 
                                onClick={handleSaveSession} 
                                className="w-full bg-green-500 text-white font-black text-xl py-7 rounded-[2.5rem] shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-all"
                            >
                                <Icons.Save /> ENREGISTRER SESSION
                            </button>
                        </div>

                        {sessions.length > 0 && (
                            <div className="space-y-3 px-1">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-[11px] font-black glass-label uppercase tracking-widest">Derni√®res sessions</h3>
                                    <span className="text-[10px] bg-white/10 px-3 py-1 rounded-full glass-text font-black">{Math.min(sessions.length, 14)}</span>
                                </div>
                                <div className="space-y-3">
                                    {sessions.slice(0, 14).map((s, i) => (
                                        <div key={i} className="glass-card p-5 rounded-[2rem] shadow-sm flex justify-between items-center animate-in slide-in-from-bottom-2 duration-300">
                                            <div className="overflow-hidden space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <p className="font-black text-sm glass-text leading-tight">
                                                        {s.date} <span className="text-white/20 mx-1">|</span> {s.tempsRappel}
                                                    </p>
                                                    {s.aboiement && <span className="text-orange-400"><Icons.Volume2 /></span>}
                                                    {s.reactionSociale === 'conflit' && <span className="text-orange-400 font-black text-[10px]">üõë CONFLIT</span>}
                                                </div>
                                                <p className="text-[11px] glass-label font-bold uppercase truncate">
                                                    {s.weather ? `${s.weather} ‚Ä¢ ` : ''}{s.location || s.environnement} ‚Ä¢ {s.attache} ‚Ä¢ {s.rappels} rappel{s.rappels > 1 ? 's' : ''}
                                                </p>
                                                {s.coords && <p className="text-[8px] font-mono opacity-40 uppercase">{s.coords}</p>}
                                            </div>
                                            <div className="bg-white/20 px-4 py-2 rounded-2xl glass-text font-black text-sm shadow-sm">
                                                {s.excitation}/5
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="pt-8 px-2 text-center flex flex-col gap-4">
                             <button 
                                onClick={() => setShowReport(true)}
                                className="w-full bg-white text-indigo-900 font-black py-5 rounded-[2.5rem] shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-all uppercase tracking-tighter"
                            >
                                <Icons.FileText /> G√âN√âRER LE BILAN
                            </button>
                            <p className="text-[10px] glass-label font-bold uppercase tracking-tight">Analyse automatique des 14 derni√®res entr√©es</p>
                            
                            <button 
                                onClick={handleResetTotal}
                                className={`mt-4 w-full font-black py-5 rounded-[2rem] flex items-center justify-center gap-3 transition-all active:scale-95 border-2 shadow-xl ${confirmReset ? 'bg-red-600 border-red-400 text-white animate-pulse' : 'bg-red-500/10 border-red-500/40 text-red-500 hover:bg-red-500/20'}`}
                            >
                                <Icons.RefreshCw /> {confirmReset ? "CONFIRMER L'EFFACEMENT ?" : "RESET DES SESSIONS"}
                            </button>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
